<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="author" content="JingXuan Yang"><meta name="description" content="从Android4.3(API18)开始，google开始引入低功耗蓝牙即蓝牙4.0模块，并提供了发现蓝牙，查询蓝牙Services和读写蓝牙特征值等api。相比之前的传统蓝牙，低功耗蓝牙能显著的降低蓝牙设备功耗。"><meta name="keywords" content=""><title>ble4.0蓝牙连接 · Xuan's Note</title><link rel="icon" href="/favicon.ico"><link rel="canonical" href="http://yoursite.com/2016/08/20/BLE 4.0蓝牙连接/"><link rel="stylesheet" href="/fonts/iconfont/iconfont.css"><link rel="stylesheet" href="/css/style.css"><script type="text/javascript">var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?3c46e20597819e1ffd65713a4c68c477";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script></head><body><div id="main"><header><a href="/." class="logo">Xuan's Note</a><ul class="nav"><li class="nav-link"><a href="/" target="_self">Home</a></li><li class="nav-link"><a href="/archives/" target="_self">Archives</a></li><li class="nav-link"><a href="/about/" target="_self">About</a></li></ul></header><section id="container"><article class="post"><h1 class="post-title">ble4.0蓝牙连接</h1><span class="post-time">Aug 20, 2016</span><div id="sidebar" class="post-sidebar"><h3 class="heading">Contents</h3><ol class="toc"><li class="toc-item toc-level-5"><a class="toc-link" href="#关键名词解析"><span class="toc-text">关键名词解析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#角色与责任"><span class="toc-text">角色与责任</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#蓝牙权限"><span class="toc-text">蓝牙权限</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#开始设置BLE"><span class="toc-text">开始设置BLE</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#查找BLE蓝牙设备"><span class="toc-text">查找BLE蓝牙设备</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#连接GATT-Server"><span class="toc-text">连接GATT Server</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#读取BLE属性"><span class="toc-text">读取BLE属性</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#接受GATT通知"><span class="toc-text">接受GATT通知</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#关闭客户端连接"><span class="toc-text">关闭客户端连接</span></a></li></ol></div><div class="post-content"><p>从Android4.3(API 18) 开始，google开始引入低功耗蓝牙即蓝牙4.0模块，并提供了发现蓝牙，查询蓝牙Services和读写蓝牙特征值等api。 相比之前的传统蓝牙，低功耗蓝牙能显著的降低蓝牙设备功耗。<br><a id="more"></a></p>
<h5 id="关键名词解析"><a href="#关键名词解析" class="headerlink" title="关键名词解析"></a>关键名词解析</h5><p>GATT :  GATT是一个通过的规范，ble上层的协议都是基于GATT，通过BLE连接发送与接收称为“属性”的数据块。目前所有的ble应用都是基于GATT。（这个通用的规范是指蓝牙设备如何在特定的应用程序中工作的规格说明）</p>
<p>ATT : GATT是在ATT协议的基础上建立的。ATT对BLE设备上的运行进行了优化，它使用了尽可能少的字节。每一个“属性”通过一个唯一的统一标识符uuid进行标识，每一个String类型的UUID使用128bit标准格式。“属性”通过ATT被格式化为characteristics和services。 </p>
<p>Characteristics : 特征值，一个特征值包括一个单一变量和0到n个用来描述该特征值的变量的Descriptor。一个特征值可以被理解成一个类型或者是一个类。</p>
<p>Descriptor : Descriptor被定义为描述特征值变量的值。例如:一个特征值可以被认为是一个可读的描述，或者一个特征值变量可以接受的范围，或者是一个特征值变量特定的测量单位。</p>
<p>Service : Service是特征值的集合。例如：可能有一个“心率监测仪”的service， 它可能包含了多个特征值，其中可能包括了一个叫做”心率测量”的特征值。</p>
<p>Profile : Profile描述了某个应用场景中设备有什么功能（执行什么工作）。在一个Profile里一般定义两个角色。如，一个报告者和一个监视着。</p>
<p>其中关系可以参考下图： <img src="http://obr1dwgsb.bkt.clouddn.com/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202016-08-20%20%E4%B8%8B%E5%8D%884.30.23.png" alt="屏幕快照 2016-08-20 下午4.30.23"></p>
<h5 id="角色与责任"><a href="#角色与责任" class="headerlink" title="角色与责任"></a>角色与责任</h5><p>Android设备与BLE设备交互有两组角色：</p>
<p>中心设备（Central）与外围设备（Peripheral）</p>
<p>即包括：GATT server与 GATT client</p>
<p>以上的这两种角色主要是取决于在蓝牙设备ble连接成功后，上诉的这两个设备的通讯方式。</p>
<p>例如：当你有一部安卓手机与一个支持ble的蓝牙追踪器。Android手机作为一个中心设备，ble蓝牙追踪器作为一个外围设备。（为了建立蓝牙连接，必须要有一个设备充当中心设备与一个设备充当外围设备。如果两个设备同时是中心设备或外围设备是无法成功建立蓝牙连接）</p>
<p>一旦两者建立起连接后，便可以开始传输GATT协议的数据包，其中依据它们传输的数据形式，有一者充当Server的角色。例如，当ble追踪器想要给手机发送数据时，此时ble追踪器便充当着一个Server角色。而当手机要给ble追踪器发送数据时，手机便充当Server角色。</p>
<h5 id="蓝牙权限"><a href="#蓝牙权限" class="headerlink" title="蓝牙权限"></a>蓝牙权限</h5><p>为了在你的应用中使用蓝牙，你需要在manifest文件中添加蓝牙权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:name=<span class="string">"android.permission.BLUETOOTH"</span>/&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">"android.permission.BLUETOOTH_ADMIN"</span>/&gt;</span><br><span class="line"><span class="comment">//如果想让你的app中，只支持ble蓝牙设备，可以加入以下声明</span></span><br><span class="line">&lt;uses-feature android:name=<span class="string">"android.hardware.bluetooth_le"</span> android:required=<span class="string">"true"</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>如果需要把app提供给不支持ble特性的蓝牙设备，需要将上面的声明改为 <code>android:required=&quot;fasle&quot;</code>同时在程序运行的时候加入判断</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Initializes Bluetooth adapter.</span></span><br><span class="line"><span class="keyword">if</span> (!getPackageManager().hasSystemFeature(PackageManager.FEATURE_BLUETOOTH_LE)) &#123;</span><br><span class="line">    Toast.makeText(<span class="keyword">this</span>, R.string.ble_not_supported, Toast.LENGTH_SHORT).show();</span><br><span class="line">    finish();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="开始设置BLE"><a href="#开始设置BLE" class="headerlink" title="开始设置BLE"></a>开始设置BLE</h5><p>1.获取BluetoothAdapter，整个系统只有一个BluetoothAdapter。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化 BluetoothAdapter</span></span><br><span class="line"><span class="keyword">final</span> BluetoothManager bluetoothManager =</span><br><span class="line">        (BluetoothManager) getSystemService(Context.BLUETOOTH_SERVICE);</span><br><span class="line">mBluetoothAdapter = bluetoothManager.getAdapter();</span><br></pre></td></tr></table></figure>
<p>2.启动蓝牙</p>
<p>在开启蓝牙的时候应该优先判断BluetoothAdapter是否为空，并且蓝牙是否已经启动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> BluetoothAdapter mBluetoothAdapter;</span><br><span class="line"><span class="comment">// 会弹出一个对话框询问用户是否开启蓝牙</span></span><br><span class="line"><span class="keyword">if</span> (mBluetoothAdapter == <span class="keyword">null</span> || !mBluetoothAdapter.isEnabled()) &#123;</span><br><span class="line">    Intent enableBtIntent = <span class="keyword">new</span> Intent(BluetoothAdapter.ACTION_REQUEST_ENABLE);</span><br><span class="line">    startActivityForResult(enableBtIntent, REQUEST_ENABLE_BT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="查找BLE蓝牙设备"><a href="#查找BLE蓝牙设备" class="headerlink" title="查找BLE蓝牙设备"></a>查找BLE蓝牙设备</h5><p>查找BLE设备的过程中，你可以使用<code>startLeScan()</code>方法进行蓝牙搜索，这个方法需要一个<code>BluetoothAdapter.LeScanCallback</code>作为参数，你需要去实现这个回调方法并判断哪些设备是你需要进行配对连接的。同时由于扫描是一个耗费手机电量的过程，因此需要遵循以下几点；</p>
<p>1.一旦扫描发现目标设备后，立即停止扫描</p>
<p>2.扫描超时后，应避免循环重复扫描浪费手机电量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * Activity 扫描和发现蓝牙设备</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeviceScanActivity</span> <span class="keyword">extends</span> <span class="title">ListActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BluetoothAdapter mBluetoothAdapter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mScanning;</span><br><span class="line">    <span class="keyword">private</span> Handler mHandler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 10秒后停止扫描</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> SCAN_PERIOD = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scanLeDevice</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> enable)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (enable) &#123;</span><br><span class="line">            <span class="comment">// 超过你设定的超时时间后停止扫描</span></span><br><span class="line">            mHandler.postDelayed(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    mScanning = <span class="keyword">false</span>;</span><br><span class="line">                    mBluetoothAdapter.stopLeScan(mLeScanCallback);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, SCAN_PERIOD);</span><br><span class="line"></span><br><span class="line">            mScanning = <span class="keyword">true</span>;</span><br><span class="line">            mBluetoothAdapter.startLeScan(mLeScanCallback);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mScanning = <span class="keyword">false</span>;</span><br><span class="line">            mBluetoothAdapter.stopLeScan(mLeScanCallback);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你只需要扫描指定类型的外围设备时，你可以调用<code>startLeScan(UUID[], BluetoothAdapter.LeScanCallback)</code>只需要提供设备的uuid数组便可</p>
<p>以下是一个<code>LeScanCallback</code>的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> LeDeviceListAdapter mLeDeviceListAdapter;</span><br><span class="line">...</span><br><span class="line"><span class="comment">// 蓝牙扫描 callback.</span></span><br><span class="line"><span class="keyword">private</span> BluetoothAdapter.LeScanCallback mLeScanCallback =</span><br><span class="line">        <span class="keyword">new</span> BluetoothAdapter.LeScanCallback() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLeScan</span><span class="params">(<span class="keyword">final</span> BluetoothDevice device, <span class="keyword">int</span> rssi,</span><br><span class="line">            <span class="keyword">byte</span>[] scanRecord)</span> </span>&#123;</span><br><span class="line">        runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               mLeDeviceListAdapter.addDevice(device);</span><br><span class="line">               mLeDeviceListAdapter.notifyDataSetChanged();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>注意：搜索ble蓝牙与搜索普通蓝牙设备，不能同时进行搜索</p>
<h5 id="连接GATT-Server"><a href="#连接GATT-Server" class="headerlink" title="连接GATT Server"></a>连接GATT Server</h5><p>通过以下方法连接GATT Server</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mBluetoothGatt = device.connectGatt(<span class="keyword">this</span>, <span class="keyword">false</span>, mGattCallback);</span><br></pre></td></tr></table></figure>
<p>连接成功后会返回一个<code>BluetoothGatt</code> 实例，通过这个实例可以进行GATT client 操作。此时app作为一个 GATT client ，而GattCallback是用来提供结果给客户端，例如连接状态等等。</p>
<h5 id="读取BLE属性"><a href="#读取BLE属性" class="headerlink" title="读取BLE属性"></a>读取BLE属性</h5><p>一旦你的app连接到一个GATT Server并且发现了服务services，就可以进行属性的读写操作了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DeviceControlActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Demonstrates how to iterate through the supported GATT</span></span><br><span class="line">    <span class="comment">// Services/Characteristics.</span></span><br><span class="line">    <span class="comment">// In this sample, we populate the data structure that is bound to the</span></span><br><span class="line">    <span class="comment">// ExpandableListView on the UI.</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">displayGattServices</span><span class="params">(List&lt;BluetoothGattService&gt; gattServices)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (gattServices == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        String uuid = <span class="keyword">null</span>;</span><br><span class="line">        String unknownServiceString = getResources().</span><br><span class="line">                getString(R.string.unknown_service);</span><br><span class="line">        String unknownCharaString = getResources().</span><br><span class="line">                getString(R.string.unknown_characteristic);</span><br><span class="line">        ArrayList&lt;HashMap&lt;String, String&gt;&gt; gattServiceData =</span><br><span class="line">                <span class="keyword">new</span> ArrayList&lt;HashMap&lt;String, String&gt;&gt;();</span><br><span class="line">        ArrayList&lt;ArrayList&lt;HashMap&lt;String, String&gt;&gt;&gt; gattCharacteristicData</span><br><span class="line">                = <span class="keyword">new</span> ArrayList&lt;ArrayList&lt;HashMap&lt;String, String&gt;&gt;&gt;();</span><br><span class="line">        mGattCharacteristics =</span><br><span class="line">                <span class="keyword">new</span> ArrayList&lt;ArrayList&lt;BluetoothGattCharacteristic&gt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Loops through available GATT Services.</span></span><br><span class="line">        <span class="keyword">for</span> (BluetoothGattService gattService : gattServices) &#123;</span><br><span class="line">            HashMap&lt;String, String&gt; currentServiceData =</span><br><span class="line">                    <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">            uuid = gattService.getUuid().toString();</span><br><span class="line">            currentServiceData.put(</span><br><span class="line">                    LIST_NAME, SampleGattAttributes.</span><br><span class="line">                            lookup(uuid, unknownServiceString));</span><br><span class="line">            currentServiceData.put(LIST_UUID, uuid);</span><br><span class="line">            gattServiceData.add(currentServiceData);</span><br><span class="line"></span><br><span class="line">            ArrayList&lt;HashMap&lt;String, String&gt;&gt; gattCharacteristicGroupData =</span><br><span class="line">                    <span class="keyword">new</span> ArrayList&lt;HashMap&lt;String, String&gt;&gt;();</span><br><span class="line">            List&lt;BluetoothGattCharacteristic&gt; gattCharacteristics =</span><br><span class="line">                    gattService.getCharacteristics();</span><br><span class="line">            ArrayList&lt;BluetoothGattCharacteristic&gt; charas =</span><br><span class="line">                    <span class="keyword">new</span> ArrayList&lt;BluetoothGattCharacteristic&gt;();</span><br><span class="line">           <span class="comment">// Loops through available Characteristics.</span></span><br><span class="line">            <span class="keyword">for</span> (BluetoothGattCharacteristic gattCharacteristic :</span><br><span class="line">                    gattCharacteristics) &#123;</span><br><span class="line">                charas.add(gattCharacteristic);</span><br><span class="line">                HashMap&lt;String, String&gt; currentCharaData =</span><br><span class="line">                        <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">                uuid = gattCharacteristic.getUuid().toString();</span><br><span class="line">                currentCharaData.put(</span><br><span class="line">                        LIST_NAME, SampleGattAttributes.lookup(uuid,</span><br><span class="line">                                unknownCharaString));</span><br><span class="line">                currentCharaData.put(LIST_UUID, uuid);</span><br><span class="line">                gattCharacteristicGroupData.add(currentCharaData);</span><br><span class="line">            &#125;</span><br><span class="line">            mGattCharacteristics.add(charas);</span><br><span class="line">            gattCharacteristicData.add(gattCharacteristicGroupData);</span><br><span class="line">         &#125;</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="接受GATT通知"><a href="#接受GATT通知" class="headerlink" title="接受GATT通知"></a>接受GATT通知</h5><p>当蓝牙设备的特征改变时会通知ble程序，以下是设置特征值通知的例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> BluetoothGatt mBluetoothGatt;</span><br><span class="line">BluetoothGattCharacteristic characteristic;</span><br><span class="line"><span class="keyword">boolean</span> enabled;</span><br><span class="line">...</span><br><span class="line">mBluetoothGatt.setCharacteristicNotification(characteristic, enabled);</span><br><span class="line">...</span><br><span class="line">BluetoothGattDescriptor descriptor = characteristic.getDescriptor(</span><br><span class="line">        UUID.fromString(SampleGattAttributes.CLIENT_CHARACTERISTIC_CONFIG));</span><br><span class="line">descriptor.setValue(BluetoothGattDescriptor.ENABLE_NOTIFICATION_VALUE);</span><br><span class="line">mBluetoothGatt.writeDescriptor(descriptor);</span><br></pre></td></tr></table></figure>
<p>一旦启用特征值改变通知，当蓝牙设备特性发生变化后，便会回调函数<code>onCharacteristicChanged()</code> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="comment">// 特征值 通知</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCharacteristicChanged</span><span class="params">(BluetoothGatt gatt,</span><br><span class="line">        BluetoothGattCharacteristic characteristic)</span> </span>&#123;</span><br><span class="line">    broadcastUpdate(ACTION_DATA_AVAILABLE, characteristic);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="关闭客户端连接"><a href="#关闭客户端连接" class="headerlink" title="关闭客户端连接"></a>关闭客户端连接</h5><p>在结束与ble设备的通讯后，需要结束并释放资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mBluetoothGatt == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mBluetoothGatt.close();</span><br><span class="line">    mBluetoothGatt = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>具体可以参考谷歌官方教程</p>
<p><a href="https://developer.android.com/guide/topics/connectivity/bluetooth-le.html" target="_blank" rel="external">Bluetooth Low Energy</a></p>
</div></article><div class="tags"></div><div class="paginator"><a href="/2016/09/08/ImageView Scale Type 使用指南/" class="prev"><i class="iconfont icon-left"></i><span> Prev</span></a><a href="/2016/05/17/WebChromeClient常用API与功能使用详解/" class="next"><span>Next</span><i class="iconfont icon-right"></i></a></div><section id="comments"><div data-thread-key="http://yoursite.com/2016/08/20/BLE 4.0蓝牙连接/index.html" data-title="ble4.0蓝牙连接" data-url="http://yoursite.com/2016/08/20/BLE 4.0蓝牙连接/index.html" class="ds-thread"></div><script type="text/javascript">var duoshuoQuery = {short_name: "yangjingxuan" };
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></section></section><footer><div class="copyright"><p class="power">Powered by <a href="https://hexo.io/">Hexo</a> and Theme by <a href="https://github.com/ahonn/hexo-theme-even"> Even</a></p><p class="since">&copy;2016<span class="heart"><i class="iconfont icon-heart"></i></span><span class="author">JingXuan Yang</span></p></div><label id="back2top"><i class="iconfont icon-up"></i></label></footer></div><script src="/js/zepto.min.js"></script><script src="/js/theme.js"></script></body></html>